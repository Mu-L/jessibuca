!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";class t{on(t,e,i){const s=this.e||(this.e={});return(s[t]||(s[t]=[])).push({fn:e,ctx:i}),this}once(t,e,i){const s=this;function r(){s.off(t,r);for(var a=arguments.length,n=new Array(a),o=0;o<a;o++)n[o]=arguments[o];e.apply(i,n)}return r._=e,this.on(t,r,i)}emit(t){const e=((this.e||(this.e={}))[t]||[]).slice();for(var i=arguments.length,s=new Array(i>1?i-1:0),r=1;r<i;r++)s[r-1]=arguments[r];for(let t=0;t<e.length;t+=1)e[t].fn.apply(e[t].ctx,s);return this}off(t,e){const i=this.e||(this.e={});if(!t)return Object.keys(i).forEach((t=>{delete i[t]})),void delete this.e;const s=i[t],r=[];if(s&&e)for(let t=0,i=s.length;t<i;t+=1)s[t].fn!==e&&s[t].fn._!==e&&r.push(s[t]);return r.length?i[t]=r:delete i[t],this}}const e="debug",i="warn",s="talkGetUserMediaSuccess",r="talkGetUserMediaFail",a="talkGetUserMediaTimeout",n="talkStreamStart",o="talkStreamOpen",l="talkStreamClose",h="talkStreamError",u="talkStreamInactive",c="talkFailedAndStop",d={talkStreamClose:l,talkStreamError:h,talkStreamInactive:u,talkGetUserMediaTimeout:a,talkFailedAndStop:c},p="tallWebsocketClosedByError",f="notConnect",g="open",m="close",k="error",b="g711a",w="g711u",_="pcm",T="opus",y=8,S=0,v=98,M="empty",U="rtp",R="tcp",G="open",A="close",B="error",L="message",F="worklet",x="script",E={encType:b,packetType:U,packetTcpSendType:R,rtpSsrc:"0000000000",numberChannels:1,sampleRate:8e3,sampleBitsWidth:16,sendInterval:20,debug:!1,debugLevel:i,testMicrophone:!1,saveRtpToFile:!1,audioBufferLength:160,engine:F,checkGetUserMediaTimeout:!1,getUserMediaTimeout:1e4,audioConstraints:{latency:!0,noiseSuppression:!0,autoGainControl:!0,echoCancellation:!0,sampleRate:48e3,channelCount:1}};var C,W,O=(C=function(t){!function(){var e="undefined"!=typeof window&&void 0!==window.document?window.document:{},i=t.exports,s=function(){for(var t,i=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],s=0,r=i.length,a={};s<r;s++)if((t=i[s])&&t[1]in e){for(s=0;s<t.length;s++)a[i[0][s]]=t[s];return a}return!1}(),r={change:s.fullscreenchange,error:s.fullscreenerror},a={request:function(t,i){return new Promise(function(r,a){var n=function(){this.off("change",n),r()}.bind(this);this.on("change",n);var o=(t=t||e.documentElement)[s.requestFullscreen](i);o instanceof Promise&&o.then(n).catch(a)}.bind(this))},exit:function(){return new Promise(function(t,i){if(this.isFullscreen){var r=function(){this.off("change",r),t()}.bind(this);this.on("change",r);var a=e[s.exitFullscreen]();a instanceof Promise&&a.then(r).catch(i)}else t()}.bind(this))},toggle:function(t,e){return this.isFullscreen?this.exit():this.request(t,e)},onchange:function(t){this.on("change",t)},onerror:function(t){this.on("error",t)},on:function(t,i){var s=r[t];s&&e.addEventListener(s,i,!1)},off:function(t,i){var s=r[t];s&&e.removeEventListener(s,i,!1)},raw:s};s?(Object.defineProperties(a,{isFullscreen:{get:function(){return Boolean(e[s.fullscreenElement])}},element:{enumerable:!0,get:function(){return e[s.fullscreenElement]}},isEnabled:{enumerable:!0,get:function(){return Boolean(e[s.fullscreenEnabled])}}}),i?t.exports=a:window.screenfull=a):i?t.exports={isEnabled:!1}:window.screenfull={isEnabled:!1}}()},C(W={exports:{}},W.exports),W.exports);function I(){return(new Date).getTime()}function z(t){let e="";if("object"==typeof t)try{e=JSON.stringify(t),e=JSON.parse(e)}catch(i){e=t}else e=t;return e}O.isEnabled,(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}})();class P{constructor(t){const{fromSampleRate:e,toSampleRate:i,channels:s,inputBufferSize:r}=t;if(!e||!i||!s)throw new Error("Invalid settings specified for the resampler.");this.resampler=null,this.fromSampleRate=e,this.toSampleRate=i,this.channels=s||0,this.inputBufferSize=r,this.initialize()}initialize(){this.fromSampleRate==this.toSampleRate?(this.resampler=t=>t,this.ratioWeight=1):(this.fromSampleRate<this.toSampleRate?(this.linearInterpolation(),this.lastWeight=1):(this.multiTap(),this.tailExists=!1,this.lastWeight=0),this.initializeBuffers(),this.ratioWeight=this.fromSampleRate/this.toSampleRate)}bufferSlice(t){try{return this.outputBuffer.subarray(0,t)}catch(e){try{return this.outputBuffer.length=t,this.outputBuffer}catch(e){return this.outputBuffer.slice(0,t)}}}initializeBuffers(){this.outputBufferSize=Math.ceil(this.inputBufferSize*this.toSampleRate/this.fromSampleRate/this.channels*1.0000004768371582)+this.channels+this.channels;try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(t){this.outputBuffer=[],this.lastOutput=[]}}linearInterpolation(){this.resampler=t=>{let e,i,s,r,a,n,o,l,h,u=t.length,c=this.channels;if(u%c!=0)throw new Error("Buffer was of incorrect sample length.");if(u<=0)return[];for(e=this.outputBufferSize,i=this.ratioWeight,s=this.lastWeight,r=0,a=0,n=0,o=0,l=this.outputBuffer;s<1;s+=i)for(a=s%1,r=1-a,this.lastWeight=s%1,h=0;h<this.channels;++h)l[o++]=this.lastOutput[h]*r+t[h]*a;for(s-=1,u-=c,n=Math.floor(s)*c;o<e&&n<u;){for(a=s%1,r=1-a,h=0;h<this.channels;++h)l[o++]=t[n+(h>0?h:0)]*r+t[n+(c+h)]*a;s+=i,n=Math.floor(s)*c}for(h=0;h<c;++h)this.lastOutput[h]=t[n++];return this.bufferSlice(o)}}multiTap(){this.resampler=t=>{let e,i,s,r,a,n,o,l,h,u,c,d=t.length,p=this.channels;if(d%p!=0)throw new Error("Buffer was of incorrect sample length.");if(d<=0)return[];for(e=this.outputBufferSize,i=[],s=this.ratioWeight,r=0,n=0,o=0,l=!this.tailExists,this.tailExists=!1,h=this.outputBuffer,u=0,c=0,a=0;a<p;++a)i[a]=0;do{if(l)for(r=s,a=0;a<p;++a)i[a]=0;else{for(r=this.lastWeight,a=0;a<p;++a)i[a]=this.lastOutput[a];l=!0}for(;r>0&&n<d;){if(o=1+n-c,!(r>=o)){for(a=0;a<p;++a)i[a]+=t[n+(a>0?a:0)]*r;c+=r,r=0;break}for(a=0;a<p;++a)i[a]+=t[n++]*o;c=n,r-=o}if(0!==r){for(this.lastWeight=r,a=0;a<p;++a)this.lastOutput[a]=i[a];this.tailExists=!0;break}for(a=0;a<p;++a)h[u++]=i[a]/s}while(n<d&&u<e);return this.bufferSlice(u)}}resample(t){return this.fromSampleRate==this.toSampleRate?this.ratioWeight=1:(this.fromSampleRate<this.toSampleRate?this.lastWeight=1:(this.tailExists=!1,this.lastWeight=0),this.initializeBuffers(),this.ratioWeight=this.fromSampleRate/this.toSampleRate),this.resampler(t)}}const q=[255,511,1023,2047,4095,8191,16383,32767];function N(t,e,i){for(let s=0;s<i;s++)if(t<=e[s])return s;return i}function $(t){const e=[];return Array.prototype.slice.call(t).forEach(((t,i)=>{e[i]=function(t){let e,i,s;return t>=0?e=213:(e=85,(t=-t-1)<0&&(t=32767)),i=N(t,q,8),i>=8?127^e:(s=i<<4,s|=i<2?t>>4&15:t>>i+3&15,s^e)}(t)})),e}function D(t){const e=[];return Array.prototype.slice.call(t).forEach(((t,i)=>{e[i]=function(t){let e=0;t<0?(t=132-t,e=127):(t+=132,e=255);let i=N(t,q,8);return i>=8?127^e:(i<<4|t>>i+3&15)^e}(t)})),e}class j{constructor(t){this.log=function(i){if(t._opt.debug&&t._opt.debugLevel==e){const e=t._opt.debugUuid?`[${t._opt.debugUuid}]`:"";for(var s=arguments.length,r=new Array(s>1?s-1:0),a=1;a<s;a++)r[a-1]=arguments[a];console.log(`JbPro${e}[✅✅✅][${i}]`,...r)}},this.warn=function(s){if(t._opt.debug&&(t._opt.debugLevel==e||t._opt.debugLevel==i)){const e=t._opt.debugUuid?`[${t._opt.debugUuid}]`:"";for(var r=arguments.length,a=new Array(r>1?r-1:0),n=1;n<r;n++)a[n-1]=arguments[n];console.log(`JbPro${e}[❗❗❗][${s}]`,...a)}},this.error=function(e){const i=t._opt.debugUuid?`[${t._opt.debugUuid}]`:"";for(var s=arguments.length,r=new Array(s>1?s-1:0),a=1;a<s;a++)r[a-1]=arguments[a];console.error(`JbPro${i}[❌❌❌][${e}]`,...r)}}}class J{constructor(t){this.destroys=[],this.proxy=this.proxy.bind(this),this.master=t}proxy(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!t)return;if(Array.isArray(e))return e.map((e=>this.proxy(t,e,i,s)));t.addEventListener(e,i,s);const r=()=>{(function(t){return"function"==typeof t})(t.removeEventListener)&&t.removeEventListener(e,i,s)};return this.destroys.push(r),r}destroy(){this.master.debug&&this.master.debug.log("Events","destroy"),this.destroys.forEach((t=>t())),this.destroys=[]}}class V extends t{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this._opt={},t&&(this.player=t),this.tag="talk";const i=z(E);this._opt=Object.assign({},i,e),this._opt.sampleRate=parseInt(this._opt.sampleRate,10),this._opt.sampleBitsWidth=parseInt(this._opt.sampleBitsWidth,10),this.audioContext=null,this.gainNode=null,this.recorder=null,this.workletRecorder=null,this.biquadFilter=null,this.userMediaStream=null,this.clearWorkletUrlTimeout=null,this.bufferSize=512,this._opt.audioBufferLength=this.calcAudioBufferLength(),this.audioBufferList=[],this.socket=null,this.socketStatus=f,this.mediaStreamSource=null,this.heartInterval=null,this.checkGetUserMediaTimeout=null,this.wsUrl=null,this.startTimestamp=0,this.sequenceId=0,this.tempTimestamp=null,this.tempRtpBufferList=[],this.events=new J(this),this._initTalk(),this.player||(this.debug=new j(this)),this._opt.encType!==b&&this._opt.encType!==w||8e3===this._opt.sampleRate&&16===this._opt.sampleBitsWidth||this.warn(this.tag,`\n            encType is ${this._opt.encType} and sampleBitsWidth is ${this._opt.sampleBitsWidth}, set sampleBitsWidth to ${this._opt.sampleBitsWidth}。\n            ${this._opt.encType} only support sampleRate 8000 and sampleBitsWidth 16`),this.log(this.tag,"init",JSON.stringify(this._opt))}destroy(){this.clearWorkletUrlTimeout&&(clearTimeout(this.clearWorkletUrlTimeout),this.clearWorkletUrlTimeout=null),this.userMediaStream&&(this.userMediaStream.getTracks&&this.userMediaStream.getTracks().forEach((t=>{t.stop()})),this.userMediaStream=null),this.mediaStreamSource&&(this.mediaStreamSource.disconnect(),this.mediaStreamSource=null),this.recorder&&(this.recorder.disconnect(),this.recorder.onaudioprocess=null,this.recorder=null),this.biquadFilter&&(this.biquadFilter.disconnect(),this.biquadFilter=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletRecorder&&(this.workletRecorder.disconnect(),this.workletRecorder=null),this.socket&&(this.socketStatus===g&&this._sendClose(),this.socket.close(),this.socket=null),this._stopHeartInterval(),this._stopCheckGetUserMediaTimeout(),this.audioContext=null,this.gainNode=null,this.recorder=null,this.audioBufferList=[],this.sequenceId=0,this.wsUrl=null,this.tempTimestamp=null,this.tempRtpBufferList=[],this.startTimestamp=0,this.log("talk","destroy")}addRtpToBuffer(t){const e=t.length+this.tempRtpBufferList.length,i=new Uint8Array(e);i.set(this.tempRtpBufferList,0),i.set(t,this.tempRtpBufferList.length),this.tempRtpBufferList=i}downloadRtpFile(){const t=new Blob([this.tempRtpBufferList]);try{const e=document.createElement("a");e.href=window.URL.createObjectURL(t),e.download=Date.now()+".rtp",e.click(),window.URL.revokeObjectURL(e.href)}catch(t){console.error("downloadRtpFile",t)}}calcAudioBufferLength(){const{sampleRate:t,sampleBitsWidth:e}=this._opt;return 8*t*.02/8}get socketStatusOpen(){return this.socketStatus===g}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._log("log",...e)}warn(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._log("warn",...e)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._log("error",...e)}_log(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.player?this.player.debug[t](...i):this.debug?this.debug[t](...i):console[t](...i)}_getSequenceId(){return++this.sequenceId}_createWebSocket(){return new Promise(((t,e)=>{const i=this.events.proxy;this.socket=new WebSocket(this.wsUrl),this.socket.binaryType="arraybuffer",this.emit(n),i(this.socket,G,(()=>{this.socketStatus=g,this.log(this.tag,"websocket open -> do talk"),this.emit(o),t(),this._doTalk()})),i(this.socket,L,(t=>{this.log(this.tag,"websocket message",t.data)})),i(this.socket,A,(t=>{this.socketStatus=m,this.warn(this.tag,"websocket close -> reject",t),this.emit(l),e(t)})),i(this.socket,B,(t=>{this.socketStatus=k,this.error(this.tag,"websocket error -> reject",t),this.emit(h,t),e(t)}))}))}_sendClose(){}_initTalk(){this._initMethods(),this._opt.engine===F?this._initWorklet():this._opt.engine===x&&this._initScriptProcessor(),this.log(this.tag,"audioContext samplerate",this.audioContext.sampleRate)}_initMethods(){this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3}),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.biquadFilter=this.audioContext.createBiquadFilter(),this.biquadFilter.type="lowpass",this.biquadFilter.frequency.value=3e3,this.resampler=new P({fromSampleRate:this.audioContext.sampleRate,toSampleRate:this._opt.sampleRate,channels:this._opt.numberChannels,inputBufferSize:this.bufferSize})}_initScriptProcessor(){const t=this.audioContext.createScriptProcessor||this.audioContext.createJavaScriptNode;this.recorder=t.apply(this.audioContext,[this.bufferSize,this._opt.numberChannels,this._opt.numberChannels]),this.recorder.onaudioprocess=t=>this._onaudioprocess(t)}_initWorklet(){const t=function(t){const e=t.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],i=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(i)}((function(){class t extends AudioWorkletProcessor{constructor(t){super(),this._cursor=0,this._bufferSize=t.processorOptions.bufferSize,this._buffer=new Float32Array(this._bufferSize)}process(t,e,i){if(!t.length||!t[0].length)return!0;for(let e=0;e<t[0][0].length;e++)this._cursor+=1,this._cursor===this._bufferSize&&(this._cursor=0,this.port.postMessage({eventType:"data",buffer:this._buffer})),this._buffer[this._cursor]=t[0][0][e];return!0}}registerProcessor("talk-processor",t)}));this.audioContext.audioWorklet&&this.audioContext.audioWorklet.addModule(t).then((()=>{const t=new AudioWorkletNode(this.audioContext,"talk-processor",{processorOptions:{bufferSize:this.bufferSize}});t.connect(this.gainNode),t.port.onmessage=t=>{"data"===t.data.eventType&&this._encodeAudioData(t.data.buffer)},this.workletRecorder=t})),this.clearWorkletUrlTimeout=setTimeout((()=>{URL.revokeObjectURL(t),this.clearWorkletUrlTimeout=null}),1e4)}_onaudioprocess(t){const e=t.inputBuffer.getChannelData(0);this._encodeAudioData(new Float32Array(e))}_encodeAudioData(t){if(0===t[0]&&0===t[1])return void this.log(this.tag,"empty audio data");const e=this.resampler.resample(t);let i=e;if(16===this._opt.sampleBitsWidth?i=function(t){let e=t.length,i=new Int16Array(e);for(;e--;){let s=Math.max(-1,Math.min(1,t[e]));i[e]=s<0?32768*s:32767*s}return i}(e):8===this._opt.sampleBitsWidth&&(i=function(t){let e=t.length,i=new Int8Array(e);for(;e--;){let s=Math.max(-1,Math.min(1,t[e]));const r=s<0?32768*s:32767*s;i[e]=parseInt(255/(65535/(32768+r)),10)}return i}(e)),null!==i.buffer){let t=null;this._opt.encType===b?t=$(i):this._opt.encType===w?t=D(i):this._opt.encType===_&&(t=i);const e=new Uint8Array(t);for(let t=0;t<e.length;t++){let i=this.audioBufferList.length;this.audioBufferList[i++]=e[t],this.audioBufferList.length===this._opt.audioBufferLength&&(this._sendTalkMsg(new Uint8Array(this.audioBufferList)),this.audioBufferList=[])}}}_parseAudioMsg(t){let e=null;return this._opt.packetType!==U||this._opt.encType!==b&&this._opt.encType!==w?this._opt.packetType===M&&(e=t):e=this.rtpPacket(t),e}rtpPacket(t){const e=[];let i=0,s=0,r=0;const a=this._opt.rtpSsrc,n=t.length;this._opt.encType===b?i=y:this._opt.encType===w?i=S:this._opt.encType===T&&(i=v),this.startTimestamp||(this.startTimestamp=I()),r=I()-this.startTimestamp,s=this._getSequenceId();let o=0;if(this._opt.packetTcpSendType===R){const t=n+12;e[o++]=255&t>>8,e[o++]=255&t>>0}e[o++]=128,e[o++]=128+i,e[o++]=s/256,e[o++]=s%256,e[o++]=r/65536/256,e[o++]=r/65536%256,e[o++]=r%65536/256,e[o++]=r%65536%256,e[o++]=a/65536/256,e[o++]=a/65536%256,e[o++]=a%65536/256,e[o++]=a%65536%256;let l=e.concat([...t]),h=new Uint8Array(l.length);for(let t=0;t<l.length;t++)h[t]=l[t];return h}opusPacket(t){return t}_sendTalkMsg(t){null===this.tempTimestamp&&(this.tempTimestamp=I());const e=I(),i=e-this.tempTimestamp,s=this._parseAudioMsg(t);var r;this.log(this.tag,`'send talk msg and diff is ${i} and byteLength is ${s.byteLength} and length is ${s.length}, and g711 length is ${t.length}`),(!0===(r=this._opt.saveRtpToFile)||"true"===r)&&this._opt.packetType===U&&this.addRtpToBuffer(s),s&&(this.socketStatusOpen?this.socket.send(s.buffer):this.emit(p)),this.tempTimestamp=e}_doTalk(){this._getUserMedia()}_getUserMedia(){this.log(this.tag,"getUserMedia"),void 0===window.navigator.mediaDevices&&(window.navigator.mediaDevices={}),void 0===window.navigator.mediaDevices.getUserMedia&&(this.log(this.tag,"window.navigator.mediaDevices.getUserMedia is undefined and init function"),window.navigator.mediaDevices.getUserMedia=function(t){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise((function(i,s){e.call(navigator,t,i,s)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),this._opt.checkGetUserMediaTimeout&&this._startCheckGetUserMediaTimeout(),window.navigator.mediaDevices.getUserMedia({audio:this._opt.audioConstraints,video:!1}).then((t=>{this.log(this.tag,"getUserMedia success"),this.userMediaStream=t,this.mediaStreamSource=this.audioContext.createMediaStreamSource(t),this.mediaStreamSource.connect(this.biquadFilter),this.recorder?(this.biquadFilter.connect(this.recorder),this.recorder.connect(this.gainNode)):this.workletRecorder&&(this.biquadFilter.connect(this.workletRecorder),this.workletRecorder.connect(this.gainNode)),this.gainNode.connect(this.audioContext.destination),this.emit(s),null===t.oninactive&&(t.oninactive=t=>{this._handleStreamInactive(t)})})).catch((t=>{this.error(this.tag,"getUserMedia error",t.toString()),this.emit(r,t.toString())})).finally((()=>{this.log(this.tag,"getUserMedia finally"),this._stopCheckGetUserMediaTimeout()}))}_getUserMedia2(){this.log(this.tag,"getUserMedia"),navigator.mediaDevices?navigator.mediaDevices.getUserMedia({audio:!0}).then((t=>{this.log(this.tag,"getUserMedia2 success")})):navigator.getUserMedia({audio:!0},this.log(this.tag,"getUserMedia2 success"),this.log(this.tag,"getUserMedia2 fail"))}async _getUserMedia3(){this.log(this.tag,"getUserMedia3");try{const t=await navigator.mediaDevices.getUserMedia({audio:{latency:!0,noiseSuppression:!0,autoGainControl:!0,echoCancellation:!0,sampleRate:48e3,channelCount:1},video:!1});console.log("getUserMedia() got stream:",t),this.log(this.tag,"getUserMedia3 success")}catch(t){this.log(this.tag,"getUserMedia3 fail")}}_handleStreamInactive(t){this.userMediaStream&&(this.warn(this.tag,"stream oninactive",t),this.emit(u))}_startCheckGetUserMediaTimeout(){this._stopCheckGetUserMediaTimeout(),this.checkGetUserMediaTimeout=setTimeout((()=>{this.log(this.tag,"check getUserMedia timeout"),this.emit(a)}),this._opt.getUserMediaTimeout)}_stopCheckGetUserMediaTimeout(){this.checkGetUserMediaTimeout&&(this.log(this.tag,"stop checkGetUserMediaTimeout"),clearTimeout(this.checkGetUserMediaTimeout),this.checkGetUserMediaTimeout=null)}_startHeartInterval(){this.heartInterval=setInterval((()=>{this.log(this.tag,"heart interval");let t=[35,36,0,0,0,0,0,0];t=new Uint8Array(t),this.socket.send(t.buffer)}),15e3)}_stopHeartInterval(){this.heartInterval&&(this.log(this.tag,"stop heart interval"),clearInterval(this.heartInterval),this.heartInterval=null)}startTalk(t){return new Promise(((e,i)=>{if(!function(){let t=!1;const e=window.navigator;return e&&(t=!(!e.mediaDevices||!e.mediaDevices.getUserMedia),t||(t=!!(e.getUserMedia||e.webkitGetUserMedia||e.mozGetUserMedia||e.msGetUserMedia))),t}())return i("not support getUserMedia");if(this.wsUrl=t,this._opt.testMicrophone)this._doTalk();else{if(!this.wsUrl)return i("wsUrl is null");this._createWebSocket().catch((t=>{i(t)}))}this.once(r,(()=>{i("getUserMedia fail")})),this.once(s,(()=>{e()}))}))}setVolume(t){var e,i,s;(t=parseFloat(t).toFixed(2),isNaN(t))||(e=t,i=0,s=1,t=Math.max(Math.min(e,Math.max(i,s)),Math.min(i,s)),this.gainNode.gain.value=t)}getOption(){return this._opt}get volume(){return this.gainNode?parseFloat(100*this.gainNode.gain.value).toFixed(0):null}}class H extends t{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.talk=null,this._opt=t,this.LOG_TAG="JessibucaProTalk",this.debug=new j(this),this.debug.log(this.LOG_TAG,"init",JSON.stringify(t))}destroy(){this.debug.log(this.LOG_TAG,"destroy()"),this.off(),this.talk&&(this.talk.destroy(),this.talk=null),this.debug.log(this.LOG_TAG,"destroy")}_initTalk(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.talk&&(this.debug.log(this.LOG_TAG,"_initTalk this.talk is not null and destroy"),this.talk.destroy(),this.talk=null);const e=Object.assign({},z(this._opt),t);this.talk=new V(null,e),this.debug.log(this.LOG_TAG,"_initTalk",this.talk.getOption()),this._bindTalkEvents()}_bindTalkEvents(){Object.keys(d).forEach((t=>{this.talk.on(d[t],(e=>{this.emit(t,e)}))}))}startTalk(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(((i,s)=>{this.debug.log(this.LOG_TAG,"startTalk",t,JSON.stringify(e)),this._initTalk(e),this.talk.startTalk(t).then((()=>{i(),this.talk.once(l,(()=>{this.debug.warn(this.LOG_TAG,"talkStreamClose -> stopTalk"),this.stopTalk().catch((t=>{this.debug.warn(this.LOG_TAG,"talkStreamClose stopTalk",t)})).finally((()=>{this.emit(c,l)}))})),this.talk.once(h,(t=>{this.debug.error(this.LOG_TAG,"talkStreamError -> stopTalk"),this.stopTalk().catch((t=>{this.debug.warn(this.LOG_TAG,"talkStreamError stopTalk",t)})).finally((()=>{this.emit(c,h)}))})),this.talk.once(u,(()=>{this.debug.warn(this.LOG_TAG,"talkStreamInactive -> stopTalk"),this.stopTalk().catch((t=>{this.debug.warn(this.LOG_TAG,"talkStreamInactive stopTalk",t)})).finally((()=>{this.emit(c,u)}))})),this.talk.once(a,(()=>{this.debug.warn(this.LOG_TAG,"talkGetUserMediaTimeout -> stopTalk"),this.stopTalk().catch((t=>{this.debug.warn(this.LOG_TAG,"talkGetUserMediaTimeout stopTalk",t)})).finally((()=>{this.emit(c,a)}))}))})).catch((t=>{s(t)}))}))}stopTalk(){return new Promise(((t,e)=>{this.debug.log(this.LOG_TAG,"stopTalk()"),this.talk||e("talk is not init"),this.talk.destroy(),this.talk=null,t()}))}getTalkVolume(){return new Promise(((t,e)=>{this.talk||e("talk is not init"),t(this.talk.volume)}))}setTalkVolume(t){return new Promise(((e,i)=>{this.debug.log(this.LOG_TAG,"setTalkVolume",t),this.talk||i("talk is not init"),this.talk.setVolume(t/100),e()}))}downloadTempRtpFile(){return new Promise(((t,e)=>{this.talk?(this.talk.downloadRtpFile(),t()):e("talk is not init")}))}}H.EVENTS=d,window.JessibucaProTalk=H,window.WebPlayerProTalk=H}));
